<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¤¿å­ AI åŠ©æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', Arial, sans-serif;
            background: #fff;
            height: 100vh;
            overflow: hidden;
        }

        /* é¡¶éƒ¨è§†é¢‘åŒº */
        .video-section {
            height: 40vh;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .video-title {
            font-size: 20px;
            color: white;
            font-weight: bold;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .avatar-video {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            object-fit: cover;
            object-position: center -70px;
            border: 4px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            color: #ff6b81;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .status-badge.active {
            background: #ff6b81;
            color: white;
        }

        /* åº•éƒ¨èŠå¤©åŒº */
        .chat-section {
            height: 60vh;
            display: flex;
            flex-direction: column;
            background: #f8f8f8;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            -webkit-overflow-scrolling: touch;
        }

        .message {
            margin-bottom: 12px;
            display: flex;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.assistant {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 75%;
            padding: 10px 14px;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.5;
            font-size: 15px;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: white;
        }

        .message.assistant .message-bubble {
            background: white;
            color: #333;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* è¾“å…¥åŒº */
        .input-area {
            background: white;
            padding: 12px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .voice-btn {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }

        .voice-btn.active {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .input-box {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid #ff9a9e;
            border-radius: 22px;
            font-size: 15px;
            outline: none;
        }

        .send-btn {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }

        .send-btn:disabled {
            opacity: 0.5;
        }
    </style>
</head>

<body>
    <div class="video-section">
        <div class="video-title">ğŸŒ¸ æ¤¿å­</div>
        <video id="standVideo" class="avatar-video" autoplay loop muted playsinline src="stand.mp4"></video>
        <video id="talkVideo" class="avatar-video" loop muted playsinline src="talk.mp4" style="display: none;"></video>
        <div class="status-badge" id="status">ğŸ’¤ å¾…æœºä¸­</div>
    </div>

    <div class="chat-section">
        <div class="messages-container" id="messages">
            <div class="message assistant">
                <div class="message-bubble">
                    ä½ å¥½å‘€ï½æˆ‘æ˜¯æ¤¿å­ï¼Œæˆ‘å¯ä»¥é™ªä½ ä¸€èµ·åº¦è¿‡æ— èŠçš„æ—¶å…‰ï¼Œæƒ³èŠäº›ä»€ä¹ˆå‘¢ï¼Ÿ
                </div>
            </div>
            <div class="message assistant">
                <div class="message-bubble" style="background: #fff3cd; color: #856404; border: 1px solid #ffeeba;">
                    ğŸ’¡ æç¤ºï¼šç‚¹å‡»è¾“å…¥æ¡†æˆ–å‘é€æŒ‰é’®å¯æ¿€æ´»è¯­éŸ³åŠŸèƒ½
                </div>
            </div>
        </div>

        <div class="input-area">
            <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()">ğŸ¤</button>
            <input type="text" class="input-box" id="input" placeholder="å’Œæ¤¿å­èŠå¤©..."
                onkeypress="if(event.key==='Enter') sendMessage()">
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">ğŸ“¤</button>
        </div>
    </div>

    <script>
        const API_BASE = 'https://api.deepseek.com/v1';
        const API_KEY = 'sk-e2567be66ddd47d8ac991786f6b5faff';
        const messagesContainer = document.getElementById('messages');
        const inputBox = document.getElementById('input');
        const statusBadge = document.getElementById('status');
        const sendBtn = document.getElementById('sendBtn');
        const standVideo = document.getElementById('standVideo');
        const talkVideo = document.getElementById('talkVideo');
        const voiceBtn = document.getElementById('voiceBtn');

        let conversationHistory = [{
            role: "system",
            content: "ä½ æ˜¯æ¤¿å­ï¼Œæ¸©æŸ”ä½“è´´çš„AIä¼™ä¼´ã€‚è¯´è¯äº²åˆ‡è‡ªç„¶ï¼Œå¤šç”¨'å‘¢'ã€'å“¦'ã€'å‘€'ç­‰è¯­æ°”è¯ã€‚å›ç­”ç®€æ´æ¸©æš–ï¼Œæ¯æ¬¡80å­—ä»¥å†…ã€‚"
        }];

        let synthesis = window.speechSynthesis;
        let recognition = null;
        let isListening = false;

        function switchVideo(talking) {
            if (talking) {
                standVideo.style.display = 'none';
                talkVideo.style.display = 'block';
                talkVideo.currentTime = 0;
                talkVideo.play();
            } else {
                talkVideo.pause();
                talkVideo.style.display = 'none';
                standVideo.style.display = 'block';
                standVideo.play();
            }
        }

        function setStatus(text, active = false) {
            statusBadge.textContent = text;
            statusBadge.classList.toggle('active', active);
        }

        function addMessage(text, isUser) {
            const msg = document.createElement('div');
            msg.className = `message ${isUser ? 'user' : 'assistant'}`;
            msg.innerHTML = `<div class="message-bubble">${text.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>`;
            messagesContainer.appendChild(msg);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function speakText(text) {
            return new Promise((resolve) => {
                synthesis.cancel();
                switchVideo(true);

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-CN';
                utterance.rate = 0.95; // ç¨æ…¢çš„è¯­é€Ÿï¼Œæ›´æ¸©æŸ”
                utterance.pitch = 1.4; // æ›´é«˜çš„éŸ³è°ƒï¼Œæ›´ç”œç¾
                utterance.volume = 1.0;

                const voices = synthesis.getVoices();
                // ä¼˜å…ˆé€‰æ‹©æœ€ç”œç¾çš„å¥³å£°
                const preferredVoices = [
                    voices.find(v => v.name.includes('Xiaoxiao')), // å¾®è½¯æ™“æ™“ï¼ˆç”œç¾ï¼‰
                    voices.find(v => v.name.includes('Xiaoyi')),   // å¾®è½¯æ™“ä¼Š
                    voices.find(v => v.name.includes('Xiaomeng')), // å¾®è½¯æ™“æ¢¦
                    voices.find(v => v.lang.includes('zh') && v.name.includes('Female')),
                    voices.find(v => v.lang.includes('zh') && !v.name.includes('Male'))
                ];
                const femaleVoice = preferredVoices.find(v => v);
                if (femaleVoice) {
                    utterance.voice = femaleVoice;
                    console.log('ä½¿ç”¨è¯­éŸ³:', femaleVoice.name);
                }

                utterance.onstart = () => {
                    setStatus('ğŸ’• è¯´è¯ä¸­', true);
                    console.log('å¼€å§‹æ’­æ”¾è¯­éŸ³');
                };

                utterance.onend = () => {
                    switchVideo(false);
                    setStatus('ğŸ’¤ å¾…æœºä¸­');
                    console.log('è¯­éŸ³æ’­æ”¾ç»“æŸ');
                    resolve();
                };

                utterance.onerror = (event) => {
                    console.error('è¯­éŸ³é”™è¯¯:', event);
                    switchVideo(false);
                    setStatus('ğŸ’¤ å¾…æœºä¸­');
                    resolve();
                };

                // ç¡®ä¿éŸ³é¢‘å·²åˆå§‹åŒ–
                initAudio();
                synthesis.speak(utterance);
                console.log('è¯­éŸ³å·²æ·»åŠ åˆ°é˜Ÿåˆ—');
            });
        }

        async function sendMessage() {
            const text = inputBox.value.trim();
            if (!text) return;

            // ç¡®ä¿éŸ³é¢‘å·²åˆå§‹åŒ–
            initAudio();

            addMessage(text, true);
            inputBox.value = '';
            sendBtn.disabled = true;

            conversationHistory.push({ role: "user", content: text });
            setStatus('ğŸ’­ æ€è€ƒä¸­', true);

            try {
                const response = await fetch(`${API_BASE}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: conversationHistory,
                        temperature: 0.9,
                        max_tokens: 200
                    })
                });

                const data = await response.json();
                if (data.choices?.[0]) {
                    const reply = data.choices[0].message.content;
                    addMessage(reply, false);

                    // å¼ºåˆ¶åˆå§‹åŒ–å¹¶æ’­æ”¾
                    initAudio();
                    console.log('å‡†å¤‡æ’­æ”¾:', reply);
                    await speakText(reply);

                    conversationHistory.push({ role: "assistant", content: reply });

                    if (conversationHistory.length > 16) {
                        conversationHistory = [conversationHistory[0], ...conversationHistory.slice(-15)];
                    }
                }
            } catch (error) {
                addMessage('ç½‘ç»œå‡ºäº†ç‚¹é—®é¢˜å‘¢...', false);
                setStatus('ğŸ’¤ å¾…æœºä¸­');
            } finally {
                sendBtn.disabled = false;
            }
        }

        function toggleVoice() {
            if (!isListening) {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognition = new SpeechRecognition();
                    recognition.lang = 'zh-CN';
                    recognition.continuous = false;

                    recognition.onstart = () => {
                        isListening = true;
                        voiceBtn.classList.add('active');
                        setStatus('ğŸ‘‚ å¬ä½ è¯´', true);
                    };

                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        inputBox.value = transcript;
                        sendMessage();
                    };

                    recognition.onend = () => {
                        isListening = false;
                        voiceBtn.classList.remove('active');
                        if (statusBadge.textContent === 'ğŸ‘‚ å¬ä½ è¯´') {
                            setStatus('ğŸ’¤ å¾…æœºä¸­');
                        }
                    };

                    recognition.onerror = () => {
                        isListening = false;
                        voiceBtn.classList.remove('active');
                        setStatus('ğŸ’¤ å¾…æœºä¸­');
                    };

                    recognition.start();
                } else {
                    alert('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«');
                }
            }
        }

        // åˆå§‹åŒ–
        let audioInitialized = false;
        let voicesLoaded = false;

        function initAudio() {
            if (!audioInitialized && 'speechSynthesis' in window) {
                try {
                    // å¼ºåˆ¶è§£é”éŸ³é¢‘
                    const dummy = new SpeechSynthesisUtterance(' ');
                    dummy.volume = 0.01;
                    speechSynthesis.speak(dummy);

                    // ç«‹å³å–æ¶ˆï¼Œä½†å·²è§£é”
                    setTimeout(() => speechSynthesis.cancel(), 100);

                    audioInitialized = true;
                    console.log('âœ… éŸ³é¢‘å·²è§£é”');

                    // æ˜¾ç¤ºæç¤º
                    setStatus('âœ… éŸ³é¢‘å·²æ¿€æ´»', false);
                    setTimeout(() => setStatus('ğŸ’¤ å¾…æœºä¸­', false), 2000);
                } catch (e) {
                    console.error('éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥:', e);
                }
            }
        }

        // å¤šç§æ–¹å¼ç›‘å¬ç”¨æˆ·äº¤äº’
        document.addEventListener('touchstart', initAudio);
        document.addEventListener('touchend', initAudio);
        document.addEventListener('click', initAudio);
        inputBox.addEventListener('focus', initAudio);
        sendBtn.addEventListener('click', initAudio);

        if ('speechSynthesis' in window) {
            // å¼ºåˆ¶åŠ è½½è¯­éŸ³åˆ—è¡¨
            const loadVoices = () => {
                const voices = speechSynthesis.getVoices();
                if (voices.length > 0 && !voicesLoaded) {
                    voicesLoaded = true;
                    const zhVoices = voices.filter(v => v.lang.includes('zh'));
                    console.log('âœ… è¯­éŸ³å·²åŠ è½½:', zhVoices.length, 'ä¸ªä¸­æ–‡è¯­éŸ³');
                    zhVoices.forEach(v => console.log('  -', v.name));
                }
            };

            loadVoices();
            speechSynthesis.onvoiceschanged = loadVoices;

            // æ¯ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œç›´åˆ°åŠ è½½å®Œæˆ
            const checkInterval = setInterval(() => {
                if (!voicesLoaded) {
                    loadVoices();
                } else {
                    clearInterval(checkInterval);
                }
            }, 1000);
        }

        // æµ‹è¯•è¯­éŸ³åŠŸèƒ½ï¼ˆè°ƒè¯•ç”¨ï¼‰
        window.testVoice = function () {
            initAudio();
            const test = new SpeechSynthesisUtterance('æµ‹è¯•ï¼Œæ¤¿å­çš„å£°éŸ³');
            test.lang = 'zh-CN';
            test.rate = 0.95;
            test.pitch = 1.4;
            const voices = synthesis.getVoices();
            const voice = voices.find(v => v.name.includes('Xiaoxiao')) || voices.find(v => v.lang.includes('zh'));
            if (voice) test.voice = voice;
            synthesis.speak(test);
            console.log('æµ‹è¯•è¯­éŸ³å·²æ’­æ”¾');
        }

        // é˜²æ­¢é¡µé¢æ»šåŠ¨
        document.body.addEventListener('touchmove', (e) => {
            if (e.target === document.body) {
                e.preventDefault();
            }
        }, { passive: false });

        console.log('æ¤¿å­ç§»åŠ¨ç‰ˆå·²å°±ç»ªï¼');
        console.log('å¦‚æœæ²¡æœ‰å£°éŸ³ï¼Œåœ¨æ§åˆ¶å°è¾“å…¥: testVoice()');
    </script>
</body>

</html>